---
phase: 04-vote-processing
plan: 01
type: execute
---

<objective>
Parse decrypted vote bytes into structured Vote record.

Purpose: Transform raw decrypted bytes from HTTP endpoint into typed vote data with standard Votifier fields.
Output: Vote record class and VoteParser utility for parsing Votifier protocol format.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-http-endpoints/03-02-SUMMARY.md

@src/main/java/org/hyvote/plugins/votifier/http/VoteServlet.java
@src/main/java/org/hyvote/plugins/votifier/crypto/CryptoUtil.java

**Tech stack available:** Java records, standard Votifier protocol
**Established patterns:** crypto subpackage, explicit exception handling
**Constraining decisions:**
- Phase 03-02: Decrypted bytes ready for parsing in VoteServlet.doPost()
- Votifier protocol: newline-delimited fields (VOTE\nserviceName\nusername\naddress\ntimestamp)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Vote record class</name>
  <files>src/main/java/org/hyvote/plugins/votifier/vote/Vote.java</files>
  <action>
Create a new `vote` subpackage with an immutable Vote record containing:
- serviceName (String) - voting site identifier
- username (String) - player who voted
- address (String) - IP address of voter
- timestamp (long) - epoch millis of vote

Include Javadoc explaining each field's purpose and origin from Votifier protocol.
Use Java record for immutability and conciseness.
  </action>
  <verify>Code compiles without errors</verify>
  <done>Vote record exists with four fields and appropriate Javadoc</done>
</task>

<task type="auto">
  <name>Task 2: Create VoteParser utility</name>
  <files>src/main/java/org/hyvote/plugins/votifier/vote/VoteParser.java, src/main/java/org/hyvote/plugins/votifier/vote/VoteParseException.java</files>
  <action>
Create VoteParser utility class with static parse(byte[] decryptedData) method:

1. Convert bytes to String using UTF-8 charset
2. Split by newline (\n)
3. Validate format:
   - First line MUST be "VOTE" (case-insensitive)
   - Must have at least 5 lines (VOTE, serviceName, username, address, timestamp)
4. Parse fields:
   - serviceName = lines[1]
   - username = lines[2]
   - address = lines[3]
   - timestamp = parse lines[4] as long (fallback to System.currentTimeMillis() if invalid)
5. Return new Vote record

Create VoteParseException for invalid formats (similar pattern to VoteDecryptionException).
Make VoteParser final with private constructor (utility class pattern).
  </action>
  <verify>Code compiles without errors</verify>
  <done>VoteParser.parse() converts bytes to Vote record, throws VoteParseException on invalid format</done>
</task>

<task type="auto">
  <name>Task 3: Integrate parsing into VoteServlet</name>
  <files>src/main/java/org/hyvote/plugins/votifier/http/VoteServlet.java</files>
  <action>
Update VoteServlet.doPost() to parse decrypted bytes:

1. After successful decryption, call VoteParser.parse(decryptedBytes)
2. Handle VoteParseException with 400 Bad Request + "Invalid vote format" message
3. On success, log vote details if debug enabled:
   `Parsed vote: service=%s, username=%s, address=%s`
4. Store parsed Vote in local variable for Phase 4 Plan 2 (event firing)
5. Update success response to include username: "Vote received for %s"

Add imports for Vote, VoteParser, VoteParseException.
  </action>
  <verify>Code compiles without errors</verify>
  <done>VoteServlet parses decrypted bytes into Vote record, handles parse errors with 400</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Vote record exists in vote subpackage with 4 fields
- [ ] VoteParser.parse() handles valid Votifier format
- [ ] VoteParseException thrown for invalid formats
- [ ] VoteServlet integrates parsing after decryption
- [ ] All code compiles without syntax errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Vote record immutable and well-documented
- Votifier protocol format correctly parsed
- Ready for 04-02 (event firing)
</success_criteria>

<output>
After completion, create `.planning/phases/04-vote-processing/04-01-SUMMARY.md`
</output>
