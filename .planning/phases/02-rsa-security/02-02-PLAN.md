---
phase: 02-rsa-security
plan: 02
type: execute
---

<objective>
Implement key loading from PEM files and create decryption utility for vote payloads.

Purpose: Enable the plugin to load existing keys on startup and provide crypto utilities for decrypting incoming vote data in Phase 4.
Output: Complete RSAKeyManager with load capability, CryptoUtil class for vote decryption.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan in this phase:
@.planning/phases/02-rsa-security/02-01-SUMMARY.md (read after 02-01 executes)

# Key files:
@src/main/java/org/hyvote/plugins/votifier/HytaleVotifierPlugin.java
@src/main/java/org/hyvote/plugins/votifier/VotifierConfig.java
@src/main/java/org/hyvote/plugins/votifier/crypto/RSAKeyManager.java (from 02-01)

**Tech stack available:** maven, hytale-server-parent, nitrado-webserver
**Established patterns:**
- JavaPlugin lifecycle: setup() for initialization
- Java record for config
- RSAKeyManager handles key generation and PEM storage (from 02-01)

**Constraining decisions:**
- Phase 02-01: Keys stored as rsa.key (PKCS8) and rsa.pub (X509) in PEM format
- Phase 02-01: Key directory from config.keyPath()
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement key loading from PEM files</name>
  <files>src/main/java/org/hyvote/plugins/votifier/crypto/RSAKeyManager.java</files>
  <action>Add loadKeyPair(Path directory) method to RSAKeyManager. Read PEM files, strip BEGIN/END markers, decode Base64 to get DER bytes. Use KeyFactory.getInstance("RSA") with PKCS8EncodedKeySpec for private key, X509EncodedKeySpec for public key. Store loaded keys in instance fields (privateKey, publicKey). Add hasKeys() method to check if keys are loaded. Add getPrivateKey() and getPublicKey() accessors. Do NOT use external PEM parsing libraries - simple string manipulation and Base64.getMimeDecoder() is sufficient.</action>
  <verify>Manual review: loadKeyPair() correctly parses PEM format and creates key objects</verify>
  <done>loadKeyPair() successfully loads keys from existing PEM files, getPrivateKey()/getPublicKey() return loaded keys</done>
</task>

<task type="auto">
  <name>Task 2: Create CryptoUtil with vote decryption</name>
  <files>src/main/java/org/hyvote/plugins/votifier/crypto/CryptoUtil.java</files>
  <action>Create CryptoUtil class in crypto subpackage. Add static decrypt(byte[] data, PrivateKey key) method. Use Cipher.getInstance("RSA/ECB/PKCS1Padding") - this is the standard Votifier encryption scheme. Return decrypted bytes. Handle InvalidKeyException and BadPaddingException by wrapping in a VoteDecryptionException (create this custom exception). Do NOT use RSA/ECB/OAEPWithSHA-256 - it's incompatible with existing Votifier clients.</action>
  <verify>Manual review: Cipher uses RSA/ECB/PKCS1Padding (Votifier standard)</verify>
  <done>CryptoUtil.decrypt() method exists with correct cipher transformation, VoteDecryptionException for error handling</done>
</task>

<task type="auto">
  <name>Task 3: Wire key loading into plugin startup</name>
  <files>src/main/java/org/hyvote/plugins/votifier/HytaleVotifierPlugin.java</files>
  <action>Modify plugin setup() to use load-or-generate pattern: 1) Try loadKeyPair() first, 2) If IOException or keys not found, generate new keys and save. Update logging to distinguish: "Loaded existing RSA keys" vs "Generated new RSA key pair". Make RSAKeyManager accessible via getter for other classes (VoteServlet in Phase 3 will need it). Do NOT swallow exceptions - if key loading fails for reasons other than "not found", log error and disable plugin gracefully.</action>
  <verify>Plugin logs correct message for load vs generate scenarios</verify>
  <done>Plugin loads existing keys on startup, generates only if missing, RSAKeyManager accessible via plugin getter</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] loadKeyPair() reads and parses PEM files correctly
- [ ] CryptoUtil.decrypt() uses RSA/ECB/PKCS1Padding cipher
- [ ] VoteDecryptionException exists for crypto error handling
- [ ] Plugin startup loads existing keys (doesn't regenerate)
- [ ] Plugin startup generates keys only when files don't exist
- [ ] RSAKeyManager accessible via plugin.getKeyManager()
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No compilation errors
- Keys load correctly from PEM files
- Decryption utility ready for Phase 4 vote processing
- Phase 2 complete, ready for Phase 3 (HTTP Endpoints)
</success_criteria>

<output>
After completion, create `.planning/phases/02-rsa-security/02-02-SUMMARY.md`
</output>
