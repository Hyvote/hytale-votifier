---
phase: 02-rsa-security
plan: 01
type: execute
---

<objective>
Generate 2048-bit RSA key pair and store as PEM files in plugin config directory.

Purpose: Establish cryptographic foundation for secure vote reception - voting sites encrypt with public key, plugin decrypts with private key.
Output: RSAKeyManager class that generates and persists RSA key pair on first run.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context:
@.planning/phases/01-project-foundation/01-02-SUMMARY.md

# Key files from Phase 1:
@src/main/java/org/hyvote/plugins/votifier/HytaleVotifierPlugin.java
@src/main/java/org/hyvote/plugins/votifier/VotifierConfig.java

**Tech stack available:** maven, hytale-server-parent, nitrado-webserver
**Established patterns:**
- JavaPlugin lifecycle: setup() for initialization, shutdown() for cleanup
- Java record for config (immutable, concise)
- Config via static defaults() method

**Constraining decisions:**
- Phase 01-02: Default keyPath is "keys" subdirectory
- Phase 01-02: Config loading uses defaults() now; JSON file loading deferred
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RSAKeyManager class with key generation</name>
  <files>src/main/java/org/hyvote/plugins/votifier/crypto/RSAKeyManager.java</files>
  <action>Create RSAKeyManager in crypto subpackage. Use java.security.KeyPairGenerator with "RSA" algorithm and 2048-bit key size. Store KeyPair in memory after generation. Include generateKeyPair() method that creates new keypair. Use SecureRandom for key generation. Do NOT use deprecated Security providers or external crypto libraries - standard JDK crypto is sufficient and more secure.</action>
  <verify>Class compiles without errors (javac syntax check)</verify>
  <done>RSAKeyManager class exists with generateKeyPair() method returning KeyPair</done>
</task>

<task type="auto">
  <name>Task 2: Implement PEM file storage for keys</name>
  <files>src/main/java/org/hyvote/plugins/votifier/crypto/RSAKeyManager.java</files>
  <action>Add methods to RSAKeyManager: saveKeyPair(Path directory) and helper methods writePemFile(). Store private key as PKCS8 PEM (rsa.key), public key as X509 PEM (rsa.pub). PEM format: "-----BEGIN/END PRIVATE/PUBLIC KEY-----" with Base64-encoded DER. Create directory if not exists. Use Files.write() with appropriate permissions. Do NOT use BouncyCastle or external PEM libraries - Base64.getMimeEncoder() with 64-char line length produces valid PEM.</action>
  <verify>Manual review: PEM format is correct (BEGIN/END markers, Base64 body)</verify>
  <done>saveKeyPair() creates rsa.key (PKCS8) and rsa.pub (X509) in PEM format</done>
</task>

<task type="auto">
  <name>Task 3: Wire RSAKeyManager into plugin startup</name>
  <files>src/main/java/org/hyvote/plugins/votifier/HytaleVotifierPlugin.java</files>
  <action>Add RSAKeyManager field to plugin. In setup(), after loadConfig(): resolve key directory from getConfigDirectory().resolve(config.keyPath()), create RSAKeyManager, check if keys exist (rsa.key file), if not generate and save. Log key generation vs existing keys found. Do NOT generate keys if they already exist - this would break existing voting site configurations.</action>
  <verify>Plugin logs "Generated new RSA key pair" or "Found existing RSA keys" appropriately</verify>
  <done>Plugin generates keys on first run, skips generation if keys exist</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] RSAKeyManager.java exists in crypto subpackage
- [ ] Plugin startup creates keys directory if missing
- [ ] Running plugin first time generates rsa.key and rsa.pub files
- [ ] Running plugin second time logs "Found existing RSA keys"
- [ ] PEM files have correct format (BEGIN/END markers)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No compilation errors
- RSA key pair generated and persisted in PEM format
- Plugin startup integrates with RSAKeyManager
</success_criteria>

<output>
After completion, create `.planning/phases/02-rsa-security/02-01-SUMMARY.md`
</output>
