---
phase: 05-testing-debug
plan: 02
type: execute
depends_on: ["05-01"]
files_modified:
  - src/main/java/org/hyvote/plugins/votifier/command/TestVoteCommand.java
  - src/main/java/org/hyvote/plugins/votifier/HytaleVotifierPlugin.java
---

<objective>
Create /testvote command with permission node for in-game vote testing.

Purpose: Allow admins to fire test votes from in-game without browser/curl.
Output: /testvote command with hyvote.testvote permission that fires VoteEvent.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-testing-debug/05-01-SUMMARY.md

**Relevant source files:**
@src/main/java/org/hyvote/plugins/votifier/HytaleVotifierPlugin.java
@src/main/java/org/hyvote/plugins/votifier/event/VoteEvent.java
@src/main/java/org/hyvote/plugins/votifier/vote/Vote.java

**Hytale Command API (from exploration):**
- Extend CommandBase from com.hypixel.hytale.server.core.command.system.basecommands
- Constructor: super(name, descriptionKey) or super(name)
- Set permission: requirePermission("hyvote.testvote")
- Define args: withRequiredArg(), withDefaultArg() with ArgTypes
- Execute: override executeSync(CommandContext context)
- Send messages: context.sendMessage(Message.of("text")) or Message.translation(key)

**Established patterns:**
- VoteEvent firing via EventRegistry.dispatchFor() (from 04-02)
- Vote record creation (from 04-01)
- Plugin provides getEventRegistry() access
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TestVoteCommand</name>
  <files>src/main/java/org/hyvote/plugins/votifier/command/TestVoteCommand.java</files>
  <action>
Create TestVoteCommand extending CommandBase in new command subpackage.

Import statements:
- com.hypixel.hytale.server.core.command.system.basecommands.CommandBase
- com.hypixel.hytale.server.core.command.context.CommandContext
- com.hypixel.hytale.server.core.command.arguments.types.ArgTypes
- com.hypixel.hytale.server.core.command.arguments.args.RequiredArg
- com.hypixel.hytale.server.core.command.arguments.args.DefaultArg
- com.hypixel.hytale.server.core.text.Message

Constructor:
1. Call super("testvote") - command name only, no translation key needed
2. Call requirePermission("hyvote.testvote")
3. Define username arg: withRequiredArg("username", "hyvote.testvote.username.desc", ArgTypes.STRING)
4. Define serviceName arg: withDefaultArg("service", "hyvote.testvote.service.desc", ArgTypes.STRING, "TestService", "TestService")

Store plugin reference for event firing. Use field: private final HytaleVotifierPlugin plugin;
Add plugin to constructor params.

Override executeSync(CommandContext context):
1. Get username from required arg
2. Get serviceName from default arg
3. Get sender address: if context.isPlayer() get player IP, else "console"
4. Create Vote: new Vote(serviceName, username, address, System.currentTimeMillis())
5. Fire event: plugin.getEventRegistry().dispatchFor(VoteEvent.class).dispatch(new VoteEvent(plugin, vote))
6. Send feedback: context.sendMessage(Message.of("Test vote fired for " + username + " from " + serviceName))
7. Log if config.debug(): plugin.getLogger().info("Test vote command: fired VoteEvent for " + username)
  </action>
  <verify>Class compiles without syntax errors</verify>
  <done>TestVoteCommand.java exists with permission node, args, executeSync that fires VoteEvent</done>
</task>

<task type="auto">
  <name>Task 2: Register command in plugin</name>
  <files>src/main/java/org/hyvote/plugins/votifier/HytaleVotifierPlugin.java</files>
  <action>
Add command registration to setup() method.

Create new method registerCommands() following pattern:
```java
private void registerCommands() {
    TestVoteCommand testVoteCommand = new TestVoteCommand(this);
    getCommandRegistry().registerCommand(testVoteCommand);
    getLogger().at(Level.INFO).log("Registered /testvote command");
}
```

Call registerCommands() in setup() after initializeWebServer().

Add import for TestVoteCommand:
import org.hyvote.plugins.votifier.command.TestVoteCommand;

No need for command unregistration in shutdown() - command registry handles this automatically when plugin unloads.
  </action>
  <verify>Plugin compiles without syntax errors, /testvote command appears in command list</verify>
  <done>TestVoteCommand registered in plugin setup, log message confirms registration</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TestVoteCommand.java exists in command subpackage
- [ ] Command requires "hyvote.testvote" permission
- [ ] /testvote <username> fires VoteEvent
- [ ] /testvote <username> <service> uses custom service name
- [ ] Feedback message sent to command sender
- [ ] All code compiles without syntax errors
</verification>

<success_criteria>

- All tasks completed
- /testvote command functional with permission check
- VoteEvent fires correctly
- Phase 5 complete
</success_criteria>

<output>
After completion, create `.planning/phases/05-testing-debug/05-02-SUMMARY.md`:

# Phase 5 Plan 2: TestVote Command Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Phase 5 Complete

With Plan 02 complete, Phase 5 (Testing & Debug) is fully implemented:
- Plan 01: Test HTTP endpoint
- Plan 02: /testvote command

## Project Complete

All 5 phases of HytaleVotifier are now complete. The plugin provides:
1. RSA key pair generation and storage
2. HTTP POST endpoint for encrypted votes
3. HTTP GET status endpoint
4. Vote parsing and VoteEvent firing
5. Debug testing via HTTP and command

---
*Phase: 05-testing-debug*
*Completed: [date]*
</output>
