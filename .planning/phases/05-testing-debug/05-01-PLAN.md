---
phase: 05-testing-debug
plan: 01
type: execute
depends_on: []
files_modified:
  - src/main/java/org/hyvote/plugins/votifier/http/TestVoteServlet.java
  - src/main/java/org/hyvote/plugins/votifier/HytaleVotifierPlugin.java
---

<objective>
Create HTTP test endpoint for debugging vote flow without requiring encrypted payloads.

Purpose: Allow admins to test vote processing and event firing from a browser or curl.
Output: GET /Hyvote/HytaleVotifier/test endpoint that generates and fires test votes.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-vote-processing/04-02-SUMMARY.md

**Relevant source files:**
@src/main/java/org/hyvote/plugins/votifier/http/StatusServlet.java
@src/main/java/org/hyvote/plugins/votifier/http/VoteServlet.java
@src/main/java/org/hyvote/plugins/votifier/HytaleVotifierPlugin.java
@src/main/java/org/hyvote/plugins/votifier/event/VoteEvent.java
@src/main/java/org/hyvote/plugins/votifier/vote/Vote.java

**Established patterns:**
- Servlet constructor takes plugin reference (from 03-01)
- JSON response format (from 03-02, 03-03)
- VoteEvent firing via EventRegistry.dispatchFor() (from 04-02)

**Constraining decisions:**
- Debug logging conditional on config.debug() (03-02)
- Graceful degradation if WebServer absent (03-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TestVoteServlet</name>
  <files>src/main/java/org/hyvote/plugins/votifier/http/TestVoteServlet.java</files>
  <action>
Create TestVoteServlet extending HttpServlet in http subpackage.

Constructor: Takes HytaleVotifierPlugin reference (same pattern as VoteServlet/StatusServlet).

doGet handler:
1. Set Content-Type: application/json
2. Extract query parameters:
   - "username" (required) - if missing, return 400 with JSON error
   - "serviceName" (optional, default "TestService")
   - "address" (optional, default req.getRemoteAddr())
3. Create Vote record: new Vote(serviceName, username, address, System.currentTimeMillis())
4. Fire VoteEvent: plugin.getEventRegistry().dispatchFor(VoteEvent.class).dispatch(new VoteEvent(plugin, vote))
5. Log test vote if config.debug() is true
6. Return 200 with JSON: {"status": "ok", "message": "Test vote fired for {username}", "vote": {"serviceName": "...", "username": "...", "address": "...", "timestamp": ...}}

Follow StatusServlet/VoteServlet patterns for response formatting and error handling.
  </action>
  <verify>Class compiles without syntax errors: javac check on TestVoteServlet.java</verify>
  <done>TestVoteServlet.java exists with doGet handler, query param parsing, vote creation, and event firing</done>
</task>

<task type="auto">
  <name>Task 2: Register TestVoteServlet in plugin</name>
  <files>src/main/java/org/hyvote/plugins/votifier/HytaleVotifierPlugin.java</files>
  <action>
In registerServlets() method, add registration for TestVoteServlet:

```java
webServerPlugin.addServlet(this, "/test", new TestVoteServlet(this));
```

Add after existing VoteServlet and StatusServlet registrations.

Update the log message to include /test endpoint:
"Registered HTTP endpoints at /Hyvote/HytaleVotifier/vote, /status, and /test"

No conditional registration based on debug flag - test endpoint is always available (admins may need to debug in production).
  </action>
  <verify>Plugin compiles without syntax errors</verify>
  <done>TestVoteServlet registered at /test path, log message updated to show all three endpoints</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TestVoteServlet.java exists in http subpackage
- [ ] GET /test with ?username=TestPlayer returns 200 JSON
- [ ] VoteEvent is fired (would appear in logs if debug=true)
- [ ] Missing username param returns 400 error
- [ ] All code compiles without syntax errors
</verification>

<success_criteria>

- All tasks completed
- TestVoteServlet follows existing servlet patterns
- Test endpoint fires real VoteEvent
- No TypeScript/Java errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-testing-debug/05-01-SUMMARY.md`:

# Phase 5 Plan 1: Test Endpoint Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 05-02-PLAN.md (testvote command)
</output>
