---
phase: 03-http-endpoints
plan: 02
type: execute
---

<objective>
Implement POST endpoint for receiving encrypted vote payloads.

Purpose: Enable voting sites to submit RSA-encrypted vote data to the server via HTTP POST.
Output: VoteServlet that accepts encrypted payloads, validates request format, and returns appropriate HTTP status codes.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-http-endpoints/DISCOVERY.md
@.planning/phases/03-http-endpoints/03-01-SUMMARY.md

@src/main/java/org/hyvote/plugins/votifier/http/VoteServlet.java
@src/main/java/org/hyvote/plugins/votifier/crypto/CryptoUtil.java

**Tech stack available:** jakarta.servlet.http, RSA/ECB/PKCS1Padding cipher
**Established patterns:** HttpServlet doPost pattern, VoteDecryptionException
**Constraining decisions:**
- RSA/ECB/PKCS1Padding cipher for Votifier compatibility
- Encrypted payload is Base64-encoded in request body
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement VoteServlet doPost handler</name>
  <files>src/main/java/org/hyvote/plugins/votifier/http/VoteServlet.java</files>
  <action>
Replace stub implementation with full doPost handler:

1. Read request body as string (BufferedReader from req.getReader())
2. Validate payload is not empty - return 400 Bad Request if empty
3. Decode Base64 payload to bytes - catch IllegalArgumentException, return 400 if invalid
4. Attempt decryption using CryptoUtil.decrypt(bytes, plugin.getKeyManager().getPrivateKey())
5. Catch VoteDecryptionException - return 400 Bad Request with message "Invalid vote payload"
6. On success, store decrypted bytes for Phase 4 processing (for now, just log success)
7. Return 200 OK with JSON response: {"status": "received", "message": "Vote received successfully"}

Response format:
- Content-Type: application/json
- 200 OK: Vote received (decryption succeeded)
- 400 Bad Request: Empty payload, invalid Base64, or decryption failed
- 500 Internal Server Error: Unexpected exception (log with stack trace)

Add imports:
- java.io.BufferedReader
- java.util.Base64
- java.util.logging.Level
- org.hyvote.plugins.votifier.crypto.CryptoUtil
- org.hyvote.plugins.votifier.crypto.VoteDecryptionException

Note: Actual vote parsing and event firing is Phase 4. This phase just validates the payload can be decrypted.
  </action>
  <verify>Code compiles without errors (check syntax)</verify>
  <done>VoteServlet.doPost() validates request, decrypts payload, returns appropriate status codes</done>
</task>

<task type="auto">
  <name>Task 2: Add debug logging for vote reception</name>
  <files>src/main/java/org/hyvote/plugins/votifier/http/VoteServlet.java</files>
  <action>
Add conditional debug logging to VoteServlet:

1. Add method to get logger from plugin: use plugin.getLogger()
2. At start of doPost: if (plugin.getConfig().debug()) log INFO "Received vote request from %s", req.getRemoteAddr()
3. After successful decryption: if (plugin.getConfig().debug()) log INFO "Successfully decrypted vote payload (%d bytes)", decryptedBytes.length
4. On 400 error: log WARNING "Rejected vote request: %s", errorReason
5. On 500 error: log SEVERE with exception "Failed to process vote request"

Use java.util.logging.Level for log levels.
  </action>
  <verify>Code compiles without errors (check syntax)</verify>
  <done>Debug logging added for vote request lifecycle (receipt, success, rejection)</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] VoteServlet.doPost() reads and validates request body
- [ ] Base64 decoding handles invalid input gracefully
- [ ] CryptoUtil.decrypt() called with private key
- [ ] Appropriate HTTP status codes returned (200, 400, 500)
- [ ] JSON response format used
- [ ] Debug logging present and conditional on config.debug()
- [ ] All code compiles without syntax errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Vote endpoint accepts encrypted payloads
- Invalid requests rejected with 400
- Ready for Phase 4 vote parsing integration
</success_criteria>

<output>
After completion, create `.planning/phases/03-http-endpoints/03-02-SUMMARY.md`
</output>
